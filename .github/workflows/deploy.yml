name: Deploy to Production

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 15m
          script_stop: true
          script: |
            set -e

            echo "=== Cloning/updating repo ==="
            REPO_DIR="/tmp/docid-deploy"
            rm -rf "$REPO_DIR"
            git clone --depth 1 https://github.com/Africa-PID-Alliance/DOCiD.git "$REPO_DIR"

            echo "=== Deploying Backend ==="
            rsync -rlt --delete --no-perms --no-group --no-owner --omit-dir-times \
              --exclude='venv' \
              --exclude='.env' \
              --exclude='logs' \
              --exclude='uploads' \
              --exclude='__pycache__' \
              "$REPO_DIR/backend/" /home/tcc-africa/docid_project/backend-v2/

            cd /home/tcc-africa/docid_project/backend-v2
            source venv/bin/activate
            pip install -r requirements.txt --quiet

            export FLASK_APP=run.py
            flask db upgrade || echo "Warning: Migration failed - may need manual intervention"

            # Graceful reload gunicorn (send HUP to master process)
            # Use kill directly to avoid signal propagation issues
            GUNICORN_PID=$(pgrep -f 'gunicorn.*backend-v2.*wsgi:app' | head -1)
            if [ -n "$GUNICORN_PID" ]; then
              kill -HUP "$GUNICORN_PID" && echo "Gunicorn reloaded (PID: $GUNICORN_PID)"
            else
              echo "Warning: Gunicorn master process not found"
            fi

            echo "=== Deploying Frontend ==="
            rsync -rlt --delete --no-perms --no-group --no-owner --omit-dir-times \
              --exclude='node_modules' \
              --exclude='.next' \
              --exclude='.env.production' \
              --exclude='logs' \
              "$REPO_DIR/frontend/" /var/www/html/fe/

            # Load NVM for Node.js
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            cd /var/www/html/fe
            npm ci
            npm run build

            pm2 restart docid-frontend || pm2 start ecosystem.config.js --env production
            pm2 save

            echo "=== Cleanup ==="
            rm -rf "$REPO_DIR"

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            echo "=== Service Status ==="
            pgrep -fa 'gunicorn.*backend-v2' | head -1 && echo "Backend: Running" || echo "Backend: NOT running"
            pm2 status

            echo "=== Health Checks ==="
            sleep 5
            curl -sf http://localhost:6000/api/v1/health > /dev/null && echo "Backend: OK" || echo "Backend: FAILED"
            curl -sf http://localhost:3000 > /dev/null && echo "Frontend: OK" || echo "Frontend: FAILED"
